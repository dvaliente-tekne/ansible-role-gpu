#SPDX-License-Identifier: MIT-0
---
# tasks file for ./ansible-role-gpu

# =============================================================================
# Network Connectivity Check
# =============================================================================

- name: Wait for network connectivity before package installation
  ansible.builtin.command:
    cmd: ping -c 1 -W 2 archlinux.org
  register: network_check
  until: network_check.rc == 0
  retries: 30
  delay: 2
  changed_when: false
  tags:
    - gpu
    - network
    - packages

# =============================================================================
# GPU Driver Installation
# =============================================================================

- name: Set effective hostname for GPU role
  ansible.builtin.set_fact:
    gpu_effective_hostname: "{{ (hostname | default(ansible_hostname)) | upper }}"
  tags:
    - gpu
    - config

- name: Set GPU type and package list based on hostname
  ansible.builtin.set_fact:
    gpu_type: "{{ 'nvidia' if gpu_effective_hostname == (gpu_nvidia_hostname | default('') | upper) else 'intel' }}"
    gpu_packages: "{{ gpu_nvidia_packages if gpu_effective_hostname == (gpu_nvidia_hostname | default('') | upper) else gpu_intel_packages }}"
  tags:
    - gpu
    - config

- name: Display GPU configuration
  ansible.builtin.debug:
    msg: "Host: {{ gpu_effective_hostname }} | GPU Type: {{ gpu_type }} | Packages: {{ gpu_packages | length }}"
  tags:
    - gpu
    - config

# =============================================================================
# NVIDIA Installation (yugen)
# =============================================================================

- name: Install NVIDIA packages
  community.general.pacman:
    name: "{{ gpu_nvidia_packages }}"
    state: present
    extra_args: '--noconfirm --needed'
  register: nvidia_install_result
  when: gpu_effective_hostname == (gpu_nvidia_hostname | default('') | upper)
  tags:
    - gpu
    - nvidia
    - packages

# =============================================================================
# Intel/Mesa Installation (other hosts)
# =============================================================================

- name: Install Intel/Mesa packages
  community.general.pacman:
    name: "{{ gpu_intel_packages }}"
    state: present
    extra_args: '--noconfirm --needed'
  register: intel_install_result
  tags:
    - gpu
    - intel
    - packages

# =============================================================================
# Verification
# =============================================================================

- name: Verify GPU packages are installed
  ansible.builtin.command:
    cmd: "pacman -Q {{ item }}"
  loop: "{{ gpu_packages }}"
  register: gpu_package_verify
  changed_when: false
  failed_when: gpu_package_verify.rc != 0
  tags:
    - gpu
    - verify

- name: Display GPU installation summary
  ansible.builtin.debug:
    msg: |
      GPU Installation Summary for {{ gpu_effective_hostname }}:
      =============================================
      GPU Type: {{ gpu_type | upper }}
      Packages installed: {{ gpu_packages | join(', ') }}
      Installation successful: {{ (nvidia_install_result is success) if gpu_effective_hostname == (gpu_nvidia_hostname | default('') | upper) else (intel_install_result is success) }}
  tags:
    - gpu
    - verify
